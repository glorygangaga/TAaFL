# Семантика типов данных языка CPY

## 1. Поддерживаемые типы данных

| Тип                | Ключевое слово | Размер/формат              |
| ------------------ | -------------- | -------------------------- |
| Целые числа        | `int`          | 32 бита, знаковое          |
| Вещественные числа | `float`        | 32 бита, IEEE 754 binary32 |
| Строки             | `str`          | UTF-8, переменная длина    |
| Булев тип          | `bool`         | 1 байт                     |
| Пустой тип         | `void`         | 0 байт                     |

**Важно:** Тип `void` поддерживается только как возвращаемый тип функций. Объявление переменных или констант с типом void запрещено

**Ключевые принципы:**
- Все типы определяются на этапе компиляции
- Неявные преобразования между типами запрещены
  
   **Исключение:** Операции между `int` и `float` разрешены, результат всегда `float`
- Каждая переменная должна быть явно типизирована при объявлении
- Операции проверяются на совместимость типов

---

## 2. Литералы

### 2.1. Целые числа (`int`)
```cpy
42          /// положительное целое
0           /// ноль
2147483647  /// максимальное 32-битное знаковое целое
-2147483648 /// минимальное 32-битное знаковое целое
```
**Автоматический тип:** Все целочисленные литералы без десятичной точки имеют тип `int`.

**Ограничения:**
- Диапазон: от -2^31 до 2^31-1 (-2,147,483,648 до 2,147,483,647)
- Только десятичная система счисления
- Подчеркивания для разделения разрядов не поддерживаются

### 2.2 Вещественные числа (`float`)**

```cpy

3.14     /// положительное вещественное число
-2.5     /// отрицательное вещественное число
0.0      /// ноль
```

**Автоматический тип:** Все числовые литералы с десятичной точкой имеют тип `float`.

**Формат: IEEE 754 binary32 (single precision)**
- Диапазон: от примерно 1.4 x 10 ^ -45 до 3.4 x 10^38
- Точность: около 6-9 десятичных цифр

### 2.3. Булевы значения (`bool`)
```cpy
true   /// логическая истина
false  /// логическая ложь
```

**Автоматический тип:** Литералы `true` и `false` имеют тип `bool`.

### Строковый тип (`str`)
```cpy
"Hello, World!"        /// простая строка
""                     /// пустая строка
"Line 1\nLine 2"       /// строка с управляющими символами
"Значение: 42"         /// строки с Unicode
```
**Автоматический тип:** Все текстовые литералы в двойных кавычках имеют тип `str`.

**Escape-последовательности:**
- `\n` — новая строка
- `\t` — табуляция
- `\\` — обратный слеш
- `\"` — двойная кавычка

---

## 3. Операторы и их типы

### 3.1. Арифметические операторы

| Оператор | Левый операнд | Правый операнд | Тип результата | Семантика                                  | Пример                   |
| -------- | ------------- | -------------- | -------------- | ------------------------------------------ | ------------------------ |
| `+`      | `int`         | `int`          | `int`          | Сложение целых                             | `5 + 3 -> 8`             |
| `+`      | `float`       | `float`        | `float`        | Сложение вещественных                      | `3.5 + 2.1 -> 5.6`       |
| `+`      | `int`         | `float`        | `float`        | Сложение с преобразованием int->float      | `5 + 3.14 -> 8.14`       |
| `+`      | `float`       | `int`          | `float`        | Сложение с преобразованием int->float      | `3.14 + 5 -> 8.14`       |
| `-`      | `int`         | `int`          | `int`          | Вычитание целых                            | `10 - 3 -> 7`            |
| `-`      | `float`       | `float`        | `float`        | Вычитание вещественных                     | `5.7 - 2.2 -> 3.5`       |
| `-`      | `int`         | `float`        | `float`        | Вычитание с преобразованием                | `10 - 3.14 -> 6.86`      |
| `-`      | `float`       | `int`          | `float`        | Вычитание с преобразованием                | `5.7 - 2 -> 3.7`         |
| `*`      | `int`         | `int`          | `int`          | Умножение целых                            | `6 * 7 -> 42`            |
| `*`      | `float`       | `float`        | `float`        | Умножение вещественных                     | `2.5 * 4.0 -> 10.0`      |
| `*`      | `int`         | `float`        | `float`        | Умножение с преобразованием                | `3 * 2.5 -> 7.5`         |
| `*`      | `float`       | `int`          | `float`        | Умножение с преобразованием                | `2.5 * 3 -> 7.5`         |
| `/`      | `int`         | `int`          | `int`          | **Целочисленное деление** (округляет вниз) | `10 / 3 -> 3`            |
| `/`      | `float`       | `float`        | `float`        | Вещественное деление                       | `10.0 / 3.0 -> 3.333...` |
| `/`      | `int`         | `float`        | `float`        | Вещественное деление с преобразованием     | `10 / 3.0 -> 3.333...`   |
| `/`      | `float`       | `int`          | `float`        | Вещественное деление с преобразованием     | `10.0 / 3 -> 3.333...`   |
| `%`      | `int`         | `int`          | `int`          | Остаток от деления                         | `10 % 3 -> 1`            |
| `%`      | `float`       | `float`        | `float`        | Остаток от деления                         | `10.5 % 3.0 -> 1.5`      |
| `%`      | `int`         | `float`        | `float`        | Остаток с преобразованием                  | `10 % 3.5 -> 3.0`        |
| `%`      | `float`       | `int`          | `float`        | Остаток с преобразованием                  | `10.5 % 3 -> 1.5`        |
| `**`     | `int`         | `int`          | `float`        | Возведение в степень                       | `2 ** 3 -> 8.0`          |
| `**`     | `float`       | `float`        | `float`        | Возведение в степень                       | `2.5 ** 2 -> 6.25`       |
| `**`     | `int`         | `float`        | `float`        | Возведение в степень с преобразованием     | `2 ** 0.5 -> 1.414...`   |
| `**`     | `float`       | `int`          | `float`        | Возведение в степень с преобразованием     | `2.5 ** 3 -> 15.625`     |

**Важные правила:**
1. **Смешанные операции int/float разрешены:** Результат всегда `float`
2. **Целочисленное деление:** Только когда оба операнда `int`, иначе вещественное деление
3. **Один оператор деления:** `/` — семантика зависит от типов операндов
4. **Приоритет преобразований:** В смешанных операциях `int` автоматически преобразуется в `float`

### 3.2. Операторы сравнения

| Оператор             | Левый операнд | Правый операнд | Тип результата | Семантика                              | Пример                   |
| -------------------- | ------------- | -------------- | -------------- | -------------------------------------- | ------------------------ |
| `==`, `!=`           | `int`         | `int`          | `bool`         | Равенство/неравенство целых            | `5 == 5 -> true`         |
| `==`, `!=`           | `float`       | `float`        | `bool`         | Равенство/неравенство вещественных     | `3.14 == 3.14 -> true`   |
| `==`, `!=`           | `int`         | `float`        | `bool`         | Равенство с преобразованием int->float | `5 == 5.0 -> true`       |
| `==`, `!=`           | `float`       | `int`          | `bool`         | Равенство с преобразованием int->float | `5.0 == 5 -> true`       |
| `<`, `>`, `<=`, `>=` | `int`         | `int`          | `bool`         | Сравнение целых                        | `5 < 10 -> true`         |
| `<`, `>`, `<=`, `>=` | `float`       | `float`        | `bool`         | Сравнение вещественных                 | `2.5 < 3.0 -> true`      |
| `<`, `>`, `<=`, `>=` | `int`         | `float`        | `bool`         | Сравнение с преобразованием            | `5 < 5.5 -> true`        |
| `<`, `>`, `<=`, `>=` | `float`       | `int`          | `bool`         | Сравнение с преобразованием            | `5.5 > 5 -> true`        |
| `==`, `!=`           | `bool`        | `bool`         | `bool`         | Равенство/неравенство булевых          | `true == true -> true`   |
| `==`, `!=`           | `str`         | `str`          | `bool`         | Равенство/неравенство строк            | `"abc" == "abc" -> true` |
| `<`, `>`, `<=`, `>=` | `str`         | `str`          | `bool`         | Лексикографическое сравнение           | `"abc" < "def" -> true`  |

### 3.3. Логические операторы (только для `bool`)

| Оператор | Левый операнд | Правый операнд | Тип результата | Семантика      | Short-circuit? |
| -------- | ------------- | -------------- | -------------- | -------------- | -------------- |
| `and`    | `bool`        | `bool`         | `bool`         | Логическое И   | Да             |
| `or`     | `bool`        | `bool`         | `bool`         | Логическое ИЛИ | Да             |
| `not`    | `bool`        | —              | `bool`         | Логическое НЕ  | Нет            |

**Примеры:**
```cpy
true and false   /// -> false
true or false    /// -> true
not true         /// -> false
```

### 3.4. Строковый оператор

| Оператор | Левый операнд | Правый операнд | Тип результата | Семантика          |
| -------- | ------------- | -------------- | -------------- | ------------------ |
| `+`      | `str`         | `str`          | `str`          | Конкатенация строк |

```cpy
let s:str = "Hello, " + "World!";  /// конкатенация: "Hello, World!"
```

**Ограничения:**
- Конкатенация только между строками
- Другие типы требуют явного преобразования в строку

### 3.5. Операторы инкремента/декремента (только для `int`)

| Оператор | Тип   | Семантика             | Возвращаемое значение |
| -------- | ----- | --------------------- | --------------------- |
| `++x`    | `int` | Префиксный инкремент  | Увеличенное значение  |
| `x++`    | `int` | Постфиксный инкремент | Исходное значение     |
| `--x`    | `int` | Префиксный декремент  | Уменьшенное значение  |
| `x--`    | `int` | Постфиксный декремент | Исходное значение     |

**Примеры:**
```cpy
let x:int = 5;
let a:int = ++x;  /// x = 6, a = 6
let b:int = x++;  /// x = 7, b = 6
let c:int = --x;  /// x = 6, c = 6
let d:int = x--;  /// x = 5, d = 6
```

### 3.6. Тернарный оператор

| Оператор | Условие | Операнд 1 | Операнд 2 | Тип результата | Семантика                                                     |
| -------- | ------- | --------- | --------- | -------------- | ------------------------------------------------------------- |
| `? :`    | `bool`  | `T1`      | `T2`      | `T`            | Если условие истинно, возвращает первый операнд, иначе второй |

**Правила типизации:**
1.  Условие должно иметь тип `bool`.
2.  Типы второго и третьего операндов (`T1` и `T2`) должны быть **совместимы**
3.  **Совместимость** определяется следующим образом:
    *   Если `T1` и `T2` — одинаковый тип (`int`, `float`, `str`, `bool`), то тип результата `T` — этот общий тип
    *   Если один операнд `int`, а другой `float`, тип результата — `float` (происходит автоматическое преобразование `int` -> `float`)
    *   Во всех остальных случаях (например, `int` и `str`) типы несовместимы — требуется явное преобразование одного из операндов
4.  Тип результата `T` определяется **до вычисления условия** на этапе компиляции

---

## 4. Переменные и константы

### 4.1. Объявление переменных
Тип переменной обязателен при объявлении:
```cpy
let count:int = 42;           /// переменная целого типа
const PI:float = 3.14159;     /// константа вещественного типа
let flag:bool = true;         /// переменная логического типа
let name:str = "Alice";       /// переменная строкового типа
/// let nothing:void;          /// ОШИБКА компиляции: void не может быть типом переменной
/// const empty:void = ...;    /// ОШИБКА компиляции: void не может быть типом константы
```

- Каждая переменная и константа должна быть инициализирована при объявлении
- Тип инициализирующего выражения должен точно совпадать с объявленным типом (кроме автоматического преобразования в операциях)
- Константы (`const`) нельзя изменять после инициализации

### 4.2. Присваивание
Тип переменной нельзя изменить после объявления:
```cpy
let x:int = 5;
x = 10;           /// допустимо: тот же тип
/// x = "текст";   /// ошибка компиляции: несовместимые типы
```

### 4.3. Область видимости
Переменные имеют блочную область видимости:
```cpy
{
    let x:int = 5;  /// видна только внутри этого блока
    print(x);       /// OK
}
/// print(x);       /// ОШИБКА: x не видна за пределами блока
```

---

## 5. Преобразования типов

### 5.1. Автоматические преобразования (разрешены только для int->float)
- В арифметических операциях: `int` автоматически преобразуется в `float` при смешанных операциях
- В операциях сравнения: `int` автоматически преобразуется в `float` при сравнении с `float`
- **Не разрешены:** Автоматические преобразования между другими типами

### 5.2. Явные преобразования с помощью функций
Для всех других преобразований используйте встроенные функции:

| Функция       | Принимает              | Возвращает | Семантика                         | Примеры                                                                            |
| ------------- | ---------------------- | ---------- | --------------------------------- | ---------------------------------------------------------------------------------- |
| `toInt(x)`    | `str`, `float`, `bool` | `int`      | Преобразует в целое число         | `toInt("123") -> 123`<br>`toInt(3.99) -> 3`<br>`toInt(true) -> 1`                  |
| `toFloat(x)`  | `str`, `int`, `bool`   | `float`    | Преобразует в вещественное число  | `toFloat("3.14") -> 3.14`<br>`toFloat(5) -> 5.0`<br>`toFloat(false) -> 0.0`        |
| `toString(x)` | Любой тип              | `str`      | Преобразует в строку              | `toString(42) -> "42"`<br>`toString(true) -> "true"`<br>`toString(3.14) -> "3.14"` |
| `toBool(x)`   | `str`, `int`, `float`  | `bool`     | Преобразует в логическое значение | `toBool("true") -> true`<br>`toBool(1) -> true`<br>`toBool(0.0) -> false`          |

### 5.3. Правила преобразования

1. **`toInt(str)`** — преобразует строку в целое число
   - Успешно: `"123"` -> `123`
   - Ошибка выполнения: `"abc"` -> ошибка выполнения (runtime error)
   - Ошибка выполнения: `"123.45"` -> ошибка выполнения (ожидается целое)

2. **`toFloat(str)`** — преобразует строку в вещественное число
   - Успешно: `"3.14"` -> `3.14`
   - Ошибка выполнения: `"abc"` -> ошибка выполнения

3. **`toBool(str)`** — преобразует строку в логическое значение
   - `"true"` (без учета регистра) -> `true`
   - `"false"` (без учета регистра) -> `false`
   - Ошибка выполнения: другие значения -> ошибка выполнения

4. **`toBool(int/float)`** — преобразует число в логическое значение
   - `0` или `0.0` -> `false`
   - Любое другое число -> `true`

### 5.4. Специальные правила для функции `input()`

Для упрощения работы с вводом, функция `input()` поддерживает **неявное преобразование** в числовые типы при присваивании:

```cpy
/// Автоматические преобразования разрешены только для input()
let num1:int = input();      /// OK: неявное преобразование str->int
let num2:float = input();    /// OK: неявное преобразование str->float

/// Для всех других случаев преобразование должно быть явным
let str_num:str = "123";
/// let x:int = str_num;      /// ОШИБКА: неявное преобразование запрещено
let x:int = toInt(str_num);  /// OK: явное преобразование
```

### 5.5. Примеры преобразований
```cpy
/// Автоматическое преобразование int->float в операциях
let a:int = 5;
let b:float = 3.14;
let sum:float = a + b;        /// OK: 5 автоматически преобразуется в 5.0

/// Явное преобразование для других типов
let num_str:str = "123";
let num:int = toInt(num_str); /// Явное преобразование

let price:float = 99.99;
let price_display:str = toString(price);  /// "99.99"

/// ОШИБКИ (запрещены):
/// let x:int = "123";           /// Неявное преобразование string->int
/// let y:str = 42;              /// Неявное преобразование int->string
/// let z:bool = 1;              /// Неявное преобразование int->bool

/// Правильно с явными преобразованиями:
let x:int = toInt("123");     /// OK
let y:str = toString(42);     /// OK
let z:bool = toBool(1);       /// OK
```

---

## 6. Встроенные функции

### 6.1. Числовые функции

| Функция               | Тип аргументов                           | Возвращаемый тип                       | Описание                        |
| --------------------- | ---------------------------------------- | -------------------------------------- | ------------------------------- |
| `abs(x)`              | `int` или `float`                        | Соответствующий тип                    | Модуль числа                    |
| `min(a, b, ...)`      | Однотипные числа или смешанные int/float | `float` при наличии float, иначе `int` | Минимальное значение            |
| `max(a, b, ...)`      | Однотипные числа или смешанные int/float | `float` при наличии float, иначе `int` | Максимальное значение           |
| `pow(base, exponent)` | `float`, `float`                         | `float`                                | Возведение в степень            |
| `round(x)`            | `float`                                  | `float`                                | Округление до ближайшего целого |
| `ceil(x)`             | `float`                                  | `float`                                | Округление вверх                |
| `floor(x)`            | `float`                                  | `float`                                | Округление вниз                 |
| `sqrt(x)`             | `float`                                  | `float`                                | Квадратный корень               |

**Примеры:**
```cpy
abs(-5)            /// 5
abs(-3.14)         /// 3.14
min(3, 5, 1)       /// 1
min(3, 5.5, 2)     /// 2.0 (преобразование int->float)
max(3, 5, 1)       /// 5
round(3.6)         /// 4.0
ceil(3.2)          /// 4.0
floor(3.8)         /// 3.0
sqrt(16.0)         /// 4.0
```

### 6.2. Строковые функции

| Функция                    | Тип аргументов      | Возвращаемый тип | Описание                                        |
| -------------------------- | ------------------- | ---------------- | ----------------------------------------------- |
| `length(s)`                | `str`               | `int`            | Длина строки                                    |
| `substring(s, start, end)` | `str`, `int`, `int` | `str`            | Подстрока (индексы от 0, end не включительно)   |
| `contains(s, substr)`      | `str`, `str`        | `bool`           | Проверка наличия подстроки                      |
| `startsWith(s, prefix)`    | `str`, `str`        | `bool`           | Проверка начала строки                          |
| `endsWith(s, suffix)`      | `str`, `str`        | `bool`           | Проверка конца строки                           |
| `toLower(s)`               | `str`               | `str`            | Строка в нижнем регистре                        |
| `toUpper(s)`               | `str`               | `str`            | Строка в верхнем регистре                       |
| `trim(s)`                  | `str`               | `str`            | Удаление пробелов с обеих сторон                |
| `indexOf(s, substr)`       | `str`, `str`        | `int`            | Первое вхождение подстроки (-1 если не найдено) |
| `lastIndexOf(s, substr)`   | `str`, `str`        | `int`            | Последнее вхождение подстроки                   |
| `replace(s, old, new)`     | `str`, `str`, `str` | `str`            | Замена всех вхождений                           |
              |

**Примеры:**
```cpy
length("Hello")                /// 5
substring("Hello", 1, 4)       /// "ell"
contains("Hello", "ell")       /// true
startsWith("Hello", "He")      /// true
endsWith("Hello", "lo")        /// true
toLower("Hello")               /// "hello"
toUpper("Hello")               /// "HELLO"
trim("  Hello  ")              /// "Hello"
indexOf("Hello", "l")          /// 2
replace("Hello", "l", "p")     /// "Heppo"
```

### 6.3. Функции проверки типов (опционально)

| Функция      | Аргумент  | Возвращает | Описание                                            |
| ------------ | --------- | ---------- | --------------------------------------------------- |
| `isInt(x)`   | Любой тип | `bool`     | Проверяет, является ли значение целым числом        |
| `isFloat(x)` | Любой тип | `bool`     | Проверяет, является ли значение вещественным числом |
| `isStr(x)`   | Любой тип | `bool`     | Проверяет, является ли значение строкой             |
| `isBool(x)`  | Любой тип | `bool`     | Проверяет, является ли значение булевым             |

---
